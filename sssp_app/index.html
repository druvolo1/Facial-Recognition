<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .video-section {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        video {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
            background: #000;
        }

        .status {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 14px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.connected {
            background: #48bb78;
            box-shadow: 0 0 10px #48bb78;
        }

        .status-indicator.disconnected {
            background: #f56565;
            box-shadow: 0 0 10px #f56565;
        }

        .status-indicator.connecting {
            background: #f6ad55;
            box-shadow: 0 0 10px #f6ad55;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Face Recognition Monitor</h1>
            <div>Display ID: <strong id="displayId">Loading...</strong></div>
            <div>Server: <strong id="serverUrl">-</strong></div>
        </div>

        <div class="video-section">
            <video id="video" autoplay playsinline></video>
        </div>

        <div class="status">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">Initializing...</span>

            <div class="info-panel">
                <div>Camera: <span id="cameraStatus">Not started</span></div>
                <div>Server: <span id="serverStatus">Not connected</span></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SERVER_URL = 'http://172.16.1.102:5000';

        // Display info
        let displayId = 'display_' + Date.now();

        // Elements
        const video = document.getElementById('video');

        // Update display
        document.getElementById('displayId').textContent = displayId;
        document.getElementById('serverUrl').textContent = SERVER_URL;

        // Initialize
        async function init() {
            console.log('[INIT] Starting application');
            updateStatus('connecting', 'Initializing...');

            // Start camera (not async anymore)
            startCamera();

            // Test server connection
            await testServer();
        }

        // Start camera - Try multiple methods
        function startCamera() {
            console.log('[CAMERA] Requesting camera access...');
            document.getElementById('cameraStatus').textContent = 'Requesting...';

            // Method 1: Try modern API first
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                console.log('[CAMERA] Trying modern getUserMedia API');

                navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                    .then(function(stream) {
                        console.log('[CAMERA] ✓ Got stream (modern API)');
                        video.srcObject = stream;

                        video.onloadedmetadata = () => {
                            console.log('[CAMERA] ✓ Camera started:', video.videoWidth, 'x', video.videoHeight);
                            document.getElementById('cameraStatus').textContent = '✓ Active (' + video.videoWidth + 'x' + video.videoHeight + ')';
                            updateStatus('connected', 'Camera active');
                        };
                    })
                    .catch(function(error) {
                        console.error('[CAMERA] Modern API failed:', error.name, error.message);
                        console.log('[CAMERA] Falling back to legacy API...');
                        tryLegacyGetUserMedia();
                    });
            } else {
                console.log('[CAMERA] Modern API not available, trying legacy...');
                tryLegacyGetUserMedia();
            }
        }

        // Method 2: Try legacy getUserMedia API
        function tryLegacyGetUserMedia() {
            navigator.getUserMedia = navigator.getUserMedia ||
                                   navigator.webkitGetUserMedia ||
                                   navigator.mozGetUserMedia ||
                                   navigator.msGetUserMedia;

            if (navigator.getUserMedia) {
                console.log('[CAMERA] Using legacy getUserMedia API');

                try {
                    navigator.getUserMedia(
                        { 'audio': false, 'video': true },
                        function gotStream(stream) {
                            console.log('[CAMERA] ✓ Got stream (legacy API)');
                            video.srcObject = stream;

                            video.onloadedmetadata = () => {
                                console.log('[CAMERA] ✓ Camera started:', video.videoWidth, 'x', video.videoHeight);
                                document.getElementById('cameraStatus').textContent = '✓ Active (' + video.videoWidth + 'x' + video.videoHeight + ')';
                                updateStatus('connected', 'Camera active');
                            };
                        },
                        function logError(error) {
                            console.error('[CAMERA] ✗ Legacy API error:', error);
                            document.getElementById('cameraStatus').textContent = '✗ ' + error.name;
                            updateStatus('disconnected', 'Camera failed: ' + error.message);
                        }
                    );
                } catch (error) {
                    console.error('[CAMERA] ✗ Exception calling getUserMedia:', error);
                    document.getElementById('cameraStatus').textContent = '✗ Exception: ' + error.message;
                    updateStatus('disconnected', 'Camera exception: ' + error.message);
                }
            } else {
                console.error('[CAMERA] No getUserMedia API available');
                document.getElementById('cameraStatus').textContent = '✗ API not available';
                updateStatus('disconnected', 'getUserMedia not supported');
            }
        }

        // Test server connection
        async function testServer() {
            try {
                console.log('[SERVER] Testing connection...');
                document.getElementById('serverStatus').textContent = 'Testing...';

                const response = await fetch(SERVER_URL + '/api/health-check');

                if (response.ok) {
                    const data = await response.json();
                    console.log('[SERVER] ✓ Connected:', data);
                    document.getElementById('serverStatus').textContent = '✓ Connected';

                    // Register display
                    await registerDisplay();
                } else {
                    console.error('[SERVER] ✗ Status:', response.status);
                    document.getElementById('serverStatus').textContent = '✗ Error ' + response.status;
                }
            } catch (error) {
                console.error('[SERVER] ✗ Error:', error);
                document.getElementById('serverStatus').textContent = '✗ Cannot connect';
            }
        }

        // Register display with server
        async function registerDisplay() {
            try {
                console.log('[REGISTER] Registering display...');

                const response = await fetch(SERVER_URL + '/api/displays/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        display_id: displayId,
                        location: 'Test Location',
                        capabilities: {
                            camera: true,
                            screen_size: screen.width + 'x' + screen.height
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('[REGISTER] ✓ Registered:', data);
                    document.getElementById('serverStatus').textContent = '✓ Registered';
                } else {
                    console.error('[REGISTER] ✗ Failed:', response.status);
                }
            } catch (error) {
                console.error('[REGISTER] ✗ Error:', error);
            }
        }

        // Update status indicator
        function updateStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            indicator.className = 'status-indicator ' + status;
            text.textContent = message;
        }

        // Start on load
        window.addEventListener('load', init);

        // Handle Tizen back key
        if (typeof tizen !== 'undefined') {
            window.addEventListener('tizenhwkey', (e) => {
                if (e.keyName === 'back') {
                    try {
                        tizen.application.getCurrentApplication().exit();
                    } catch (ignore) {}
                }
            });
        }
    </script>
</body>
</html>
