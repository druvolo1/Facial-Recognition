<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Display - BiometriX</title>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Samsung Sharp Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0E4194 0%, #1428A0 50%, #0066B3 100%);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Greeting Overlay */
        .greeting-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            padding: 30px 50px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .greeting-overlay.visible {
            opacity: 1;
        }

        .greeting-text {
            font-size: 48px;
            font-weight: 700;
            color: white;
            text-shadow: 0 4px 20px rgba(0,0,0,0.5);
            animation: slideInDown 0.6s ease-out;
        }

        @keyframes slideInDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Product Card */
        .product-card {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .product-card.visible {
            opacity: 1;
        }

        .card-content {
            width: 100%;
            max-width: 1400px;
            height: 100%;
            background: white;
            border-radius: 30px;
            box-shadow: 0 20px 80px rgba(0,0,0,0.3);
            display: grid;
            grid-template-columns: 1fr 1fr;
            overflow: hidden;
        }

        /* Image Section */
        .image-section {
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            position: relative;
        }

        .product-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 20px;
        }

        .image-gallery-dots {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .gallery-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .gallery-dot.active {
            width: 40px;
            border-radius: 6px;
            background: #1428A0;
        }

        /* Details Section */
        .details-section {
            padding: 60px;
            display: flex;
            flex-direction: column;
        }

        .model-number {
            font-size: 24px;
            font-weight: 700;
            color: #1428A0;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .product-name {
            font-size: 42px;
            font-weight: 700;
            color: #333;
            margin-bottom: 30px;
            line-height: 1.2;
        }

        .product-description {
            font-size: 20px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .product-specs {
            flex: 1;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            overflow-y: auto;
        }

        .specs-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }

        .specs-content {
            font-size: 16px;
            color: #555;
            line-height: 1.8;
            white-space: pre-line;
        }

        /* QR Code Section */
        .qr-section {
            display: flex;
            align-items: center;
            gap: 20px;
            background: linear-gradient(135deg, #1428A0, #0066B3);
            padding: 20px 30px;
            border-radius: 15px;
            color: white;
        }

        .qr-code {
            width: 120px;
            height: 120px;
            background: white;
            padding: 10px;
            border-radius: 10px;
        }

        .qr-text {
            flex: 1;
        }

        .qr-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .qr-description {
            font-size: 20px;
            font-weight: 700;
        }

        /* Navigation Arrows */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #1428A0;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            opacity: 0;
            transition: all 0.3s;
            z-index: 200;
        }

        .nav-arrow.visible {
            opacity: 1;
        }

        .nav-arrow:hover {
            background: white;
            transform: translateY(-50%) scale(1.1);
        }

        .nav-arrow.left {
            left: 30px;
        }

        .nav-arrow.right {
            right: 30px;
        }

        /* Loading State */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255,255,255,0.3);
            border-top: 6px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 500px;
        }

        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .error-text {
            font-size: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="font-size: 20px;">Loading products...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="error-message" style="display: none;">
            <div class="error-icon">⚠️</div>
            <div class="error-text" id="error-text">No products assigned to this display</div>
        </div>

        <!-- Greeting Overlay -->
        <div id="greeting" class="greeting-overlay">
            <div class="greeting-text" id="greeting-text"></div>
        </div>

        <!-- Product Card -->
        <div id="product-card" class="product-card">
            <div class="card-content">
                <div class="image-section">
                    <img id="product-image" class="product-image" src="" alt="Product">
                    <div id="image-dots" class="image-gallery-dots"></div>
                </div>
                <div class="details-section">
                    <div class="model-number" id="model-number"></div>
                    <h1 class="product-name" id="product-name"></h1>
                    <p class="product-description" id="product-description"></p>
                    <div class="product-specs">
                        <div class="specs-title">Specifications</div>
                        <div class="specs-content" id="product-specs"></div>
                    </div>
                    <div class="qr-section">
                        <div id="qr-code" class="qr-code"></div>
                        <div class="qr-text">
                            <div class="qr-title">Learn More</div>
                            <div class="qr-description">Scan to visit product page</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Arrows -->
        <div id="nav-left" class="nav-arrow left" onclick="navigateProduct(-1)">‹</div>
        <div id="nav-right" class="nav-arrow right" onclick="navigateProduct(1)">›</div>
    </div>

    <script>
        // Configuration - Hard-coded for Tizen
        const SERVER_URL = 'http://172.16.1.102:5000';
        const API_URL = SERVER_URL;

        // Get device information from localStorage
        const DEVICE_ID = localStorage.getItem('deviceId');
        const DEVICE_NAME = localStorage.getItem('deviceName');
        const DEVICE_TYPE = localStorage.getItem('deviceType');
        const DEVICE_TOKEN = localStorage.getItem('deviceToken');

        // Validate device data
        if (!DEVICE_ID || !DEVICE_NAME || !DEVICE_TOKEN || DEVICE_TYPE !== 'content_display') {
            console.log('[CONTENT-DISPLAY] Missing or invalid device data - redirecting to registration');
            localStorage.clear();
            window.location.href = 'index.html';
        }

        let products = [];
        let currentProductIndex = 0;
        let currentImageIndex = 0;
        let autoRotateTimer = null;
        let detectedUsers = [];
        let userPresentTimer = null;
        let isUserPresent = false;
        let currentViewStartTime = null;

        // Text-to-speech
        const speech = window.speechSynthesis;
        function speak(text) {
            if (speech) {
                speech.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                speech.speak(utterance);
            }
        }

        // Initialize
        async function init() {
            console.log('[CONTENT-DISPLAY] Initializing...');
            await loadProducts();
            startWebSocketConnection();
        }

        // Load products from API
        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}/api/devices/${DEVICE_ID}/products`, {
                    headers: {
                        'X-Device-ID': DEVICE_ID,
                        'X-Device-Token': DEVICE_TOKEN
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                products = await response.json();
                console.log('[CONTENT-DISPLAY] Loaded', products.length, 'products');

                if (products.length === 0) {
                    showError('No products assigned to this display');
                    return;
                }

                document.getElementById('loading').style.display = 'none';
                displayProduct(0);
                startAutoRotation();

            } catch (error) {
                console.error('[CONTENT-DISPLAY] Error loading products:', error);
                showError('Failed to load products');
            }
        }

        // Display a product
        function displayProduct(index) {
            if (products.length === 0) return;

            // Track view duration of previous product
            if (currentViewStartTime && products[currentProductIndex]) {
                trackProductView(products[currentProductIndex].id, Math.floor((Date.now() - currentViewStartTime) / 1000));
            }

            currentProductIndex = index;
            currentImageIndex = 0;
            currentViewStartTime = Date.now();

            const product = products[currentProductIndex];
            console.log('[CONTENT-DISPLAY] Displaying:', product.model_number);

            // Update product details
            document.getElementById('model-number').textContent = product.model_number;
            document.getElementById('product-name').textContent = product.name;
            document.getElementById('product-description').textContent = product.description || '';
            document.getElementById('product-specs').textContent = product.specification || 'No specifications available';

            // Display image
            if (product.images && product.images.length > 0) {
                const primaryImage = product.images.find(img => img.is_primary) || product.images[0];
                document.getElementById('product-image').src = `${API_URL}${primaryImage.file_path}`;

                // Update image dots
                if (product.images.length > 1) {
                    const dotsHtml = product.images.map((_, i) =>
                        `<div class="gallery-dot ${i === currentImageIndex ? 'active' : ''}"></div>`
                    ).join('');
                    document.getElementById('image-dots').innerHTML = dotsHtml;
                } else {
                    document.getElementById('image-dots').innerHTML = '';
                }
            } else {
                document.getElementById('product-image').src = '';
                document.getElementById('image-dots').innerHTML = '';
            }

            // Generate QR code
            document.getElementById('qr-code').innerHTML = '';
            if (product.product_url) {
                new QRCode(document.getElementById('qr-code'), {
                    text: product.product_url,
                    width: 100,
                    height: 100,
                    colorDark: '#1428A0',
                    colorLight: '#ffffff'
                });
            }

            // Show product card
            document.getElementById('product-card').classList.add('visible');
        }

        // Auto-rotation
        function startAutoRotation() {
            if (products.length <= 1) return;

            function rotate() {
                if (!isUserPresent) {
                    const nextIndex = (currentProductIndex + 1) % products.length;
                    displayProduct(nextIndex);
                }
                const rotationDuration = products[currentProductIndex]?.rotation_duration || 15;
                autoRotateTimer = setTimeout(rotate, rotationDuration * 1000);
            }

            const rotationDuration = products[currentProductIndex]?.rotation_duration || 15;
            autoRotateTimer = setTimeout(rotate, rotationDuration * 1000);
        }

        // Manual navigation
        function navigateProduct(direction) {
            if (products.length === 0) return;

            const newIndex = (currentProductIndex + direction + products.length) % products.length;
            displayProduct(newIndex);

            // Track interaction
            trackProductInteraction(products[newIndex].id, direction > 0 ? 'navigate_next' : 'navigate_prev');

            // Reset auto-rotation timer
            if (autoRotateTimer) {
                clearTimeout(autoRotateTimer);
                startAutoRotation();
            }
        }

        // WebSocket for face detection
        function startWebSocketConnection() {
            const ws = new WebSocket(`ws://${API_URL.replace(/^https?:\/\//, '')}/ws/detections/${DEVICE_ID}?token=${encodeURIComponent(DEVICE_TOKEN)}`);

            ws.onopen = () => {
                console.log('[WEBSOCKET] Connected');
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'detection') {
                        handleFaceDetection(data.faces || []);
                    }
                } catch (error) {
                    console.error('[WEBSOCKET] Error parsing message:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('[WEBSOCKET] Error:', error);
            };

            ws.onclose = () => {
                console.log('[WEBSOCKET] Disconnected, reconnecting in 5 seconds...');
                setTimeout(startWebSocketConnection, 5000);
            };
        }

        // Handle face detection
        function handleFaceDetection(faces) {
            if (faces.length === 0) {
                // No faces detected - clear user present timer
                if (userPresentTimer) {
                    clearTimeout(userPresentTimer);
                    userPresentTimer = setTimeout(() => {
                        hideGreeting();
                        isUserPresent = false;
                        detectedUsers = [];
                    }, 20000); // 20 seconds after last detection
                }
                return;
            }

            // Faces detected
            detectedUsers = faces.map(f => f.userid || 'Guest');
            isUserPresent = true;

            // Clear existing timer
            if (userPresentTimer) {
                clearTimeout(userPresentTimer);
            }

            // Show greeting and navigation
            showGreeting();

            // Set timer to hide after 20 seconds of no detection
            userPresentTimer = setTimeout(() => {
                hideGreeting();
                isUserPresent = false;
                detectedUsers = [];
            }, 20000);
        }

        // Show greeting
        function showGreeting() {
            let greetingText = '';

            if (detectedUsers.length === 0 || detectedUsers[0] === 'Unknown' || detectedUsers[0] === 'Guest') {
                greetingText = 'Welcome, Guest';
                speak('Welcome');
            } else if (detectedUsers.length === 1) {
                greetingText = `Welcome back, ${detectedUsers[0]}`;
                speak(`Welcome back ${detectedUsers[0]}`);
            } else if (detectedUsers.length === 2) {
                greetingText = `Welcome, ${detectedUsers[0]} & ${detectedUsers[1]}`;
                speak(`Welcome ${detectedUsers[0]} and ${detectedUsers[1]}`);
            } else {
                greetingText = `Welcome, ${detectedUsers[0]} & ${detectedUsers[1]} and others`;
                speak(`Welcome ${detectedUsers[0]} and ${detectedUsers[1]} and others`);
            }

            document.getElementById('greeting-text').textContent = greetingText;
            document.getElementById('greeting').classList.add('visible');

            // Show navigation arrows
            if (products.length > 1) {
                document.getElementById('nav-left').classList.add('visible');
                document.getElementById('nav-right').classList.add('visible');
            }
        }

        // Hide greeting
        function hideGreeting() {
            document.getElementById('greeting').classList.remove('visible');
            document.getElementById('nav-left').classList.remove('visible');
            document.getElementById('nav-right').classList.remove('visible');
        }

        // Analytics: Track product view
        async function trackProductView(productId, duration) {
            try {
                await fetch(`${API_URL}/api/products/analytics/view`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Device-ID': DEVICE_ID,
                        'X-Device-Token': DEVICE_TOKEN
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        person_id: detectedUsers[0] && detectedUsers[0] !== 'Guest' ? detectedUsers[0] : null,
                        person_name: detectedUsers[0] && detectedUsers[0] !== 'Guest' ? detectedUsers[0] : null,
                        view_duration: duration
                    })
                });
            } catch (error) {
                console.error('[ANALYTICS] Error tracking view:', error);
            }
        }

        // Analytics: Track interaction
        async function trackProductInteraction(productId, interactionType) {
            try {
                await fetch(`${API_URL}/api/products/analytics/interaction`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Device-ID': DEVICE_ID,
                        'X-Device-Token': DEVICE_TOKEN
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        person_id: detectedUsers[0] && detectedUsers[0] !== 'Guest' ? detectedUsers[0] : null,
                        person_name: detectedUsers[0] && detectedUsers[0] !== 'Guest' ? detectedUsers[0] : null,
                        interaction_type: interactionType
                    })
                });
            } catch (error) {
                console.error('[ANALYTICS] Error tracking interaction:', error);
            }
        }

        // Show error
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-text').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
