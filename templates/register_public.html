<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Face Registration - BiometriX</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Samsung Sharp Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0E4194 0%, #1428A0 50%, #0066B3 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeInDown 0.6s ease-out;
        }

        .logo img {
            height: 60px;
            background: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #1428A0, #0066B3);
        }

        /* Step Container */
        .step {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .step.active {
            display: block;
        }

        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 30px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s;
        }

        .progress-dot.active {
            width: 24px;
            border-radius: 4px;
            background: #1428A0;
        }

        .progress-dot.completed {
            background: #0066B3;
        }

        /* Typography */
        h1 {
            color: #1428A0;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 15px;
            line-height: 1.5;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        input[type="text"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #1428A0;
            box-shadow: 0 0 0 4px rgba(20, 40, 160, 0.1);
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1428A0, #0066B3);
            color: white;
            box-shadow: 0 4px 15px rgba(20, 40, 160, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(20, 40, 160, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* Camera Container */
        .camera-wrapper {
            position: relative;
            margin-bottom: 24px;
        }

        .camera-container {
            position: relative;
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .camera-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            border-radius: 0;
            width: 100vw;
            height: 100vh;
        }

        #video {
            width: 100%;
            display: block;
        }

        .camera-container.fullscreen #video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }

        #canvas {
            display: none;
        }

        /* Camera Overlay */
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .face-frame {
            width: 200px;
            height: 250px;
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            position: relative;
            transition: border-color 0.3s;
        }

        .face-frame.detected {
            border-color: #4CAF50;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .countdown-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: 700;
            color: white;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            animation: countdownPulse 1s ease-out;
        }

        @keyframes countdownPulse {
            0% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
        }

        .capture-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
        }

        .capture-indicator.flash {
            animation: flash 0.3s ease-out;
        }

        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 0.8; }
            100% { opacity: 0; }
        }

        .status-message {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            backdrop-filter: blur(10px);
        }

        .photo-progress {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        /* Photo Grid */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 3/4;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .photo-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item.profile {
            grid-column: span 3;
            aspect-ratio: 16/9;
            border: 3px solid #1428A0;
        }

        .photo-item.profile::after {
            content: 'Profile Photo';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(20, 40, 160, 0.9), transparent);
            color: white;
            padding: 8px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 20px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1428A0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success */
        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
            animation: successPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes successPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Alerts */
        .alert {
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert::before {
            font-size: 20px;
        }

        .alert-error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .alert-error::before {
            content: '⚠️';
        }

        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .alert-info::before {
            content: 'ℹ️';
        }

        /* Instructions */
        .instructions {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border-left: 4px solid #1428A0;
        }

        .instructions strong {
            color: #1428A0;
            display: block;
            margin-bottom: 12px;
            font-size: 15px;
        }

        .instructions ul {
            margin: 0;
            padding-left: 20px;
        }

        .instructions li {
            margin: 8px 0;
            color: #555;
            font-size: 14px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mobile Optimizations */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            .card {
                padding: 30px 20px;
            }

            h1 {
                font-size: 24px;
            }

            .photo-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .photo-item.profile {
                grid-column: span 2;
            }
        }

        /* Retake Button */
        .retake-section {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <img src="/static/biometric-logo.svg" alt="BiometriX">
        </div>

        <div class="card">
            <div class="progress-indicator" id="progress-indicator">
                <div class="progress-dot active" data-step="0"></div>
                <div class="progress-dot" data-step="1"></div>
                <div class="progress-dot" data-step="2"></div>
                <div class="progress-dot" data-step="3"></div>
                <div class="progress-dot" data-step="4"></div>
            </div>

            <!-- Step 0: Loading/Validation -->
            <div id="step-loading" class="step active">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="color: #666;">Validating registration link...</p>
                </div>
            </div>

            <!-- Step 1: Welcome -->
            <div id="step-welcome" class="step">
                <h1>Welcome to BiometriX</h1>
                <p class="subtitle">We'll guide you through a quick and secure facial registration process</p>

                <div class="instructions">
                    <strong>What to expect:</strong>
                    <ul>
                        <li>Enter your name</li>
                        <li>Allow camera access</li>
                        <li>Automatic photo capture (5 photos)</li>
                        <li>Quick verification</li>
                    </ul>
                </div>

                <p style="text-align: center; color: #999; font-size: 13px; margin-bottom: 20px;">
                    This process takes about 60 seconds
                </p>

                <button class="btn btn-primary" onclick="nextStep(1)">Get Started</button>
            </div>

            <!-- Step 2: Name Input -->
            <div id="step-name" class="step">
                <h1>Enter Your Information</h1>
                <p class="subtitle" id="location-info">Please provide your full name</p>

                <div class="form-group">
                    <label for="person-name">Full Name *</label>
                    <input type="text" id="person-name" placeholder="John Doe" required autofocus>
                </div>

                <button class="btn btn-primary" onclick="startCamera()">Continue</button>
                <button class="btn btn-secondary" onclick="prevStep(1)">Back</button>
            </div>

            <!-- Step 3: Camera Capture (Auto) -->
            <div id="step-camera" class="step">
                <h1>Photo Capture</h1>
                <p class="subtitle">Position your face in the frame - we'll do the rest!</p>

                <div class="camera-wrapper">
                    <div class="camera-container" id="camera-container">
                        <video id="video" autoplay playsinline muted></video>
                        <canvas id="canvas"></canvas>

                        <div class="camera-overlay">
                            <div class="face-frame" id="face-frame"></div>
                            <div class="photo-progress" id="photo-progress">0 / 5 photos</div>
                            <div class="status-message" id="status-message">Detecting face...</div>
                        </div>

                        <div class="capture-indicator" id="capture-indicator"></div>
                        <div id="countdown-number"></div>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="cancelCapture()">Cancel</button>
            </div>

            <!-- Step 4: Preview & Confirm -->
            <div id="step-preview" class="step">
                <h1>Review Your Photos</h1>
                <p class="subtitle">Make sure all photos look good before submitting</p>

                <div class="photo-grid" id="photo-preview-grid"></div>

                <button class="btn btn-primary" onclick="submitRegistration()">Submit Registration</button>

                <div class="retake-section">
                    <p style="color: #666; margin-bottom: 12px; font-size: 14px;">Not satisfied with the photos?</p>
                    <button class="btn btn-secondary" onclick="retakePhotos()">Retake Photos</button>
                </div>
            </div>

            <!-- Step 5: Processing -->
            <div id="step-processing" class="step">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="color: #333; font-weight: 600; font-size: 16px;">Processing your registration...</p>
                    <p style="font-size: 14px; color: #666; margin-top: 10px;">This may take a moment</p>
                </div>
            </div>

            <!-- Step 6: Success -->
            <div id="step-success" class="step">
                <div class="success-icon">✓</div>
                <h1>Registration Complete!</h1>
                <p class="subtitle">Your face has been successfully registered</p>
                <div class="alert alert-info" id="success-message" style="border: none; background: #f0f7ff;"></div>
            </div>

            <!-- Alert container -->
            <div id="alert-container"></div>
        </div>
    </div>

    <script>
        const linkId = "{{ link_id }}";
        let linkInfo = null;
        let capturedPhotos = [];
        let profilePhoto = null;
        let stream = null;
        let currentStep = 0;
        let captureInProgress = false;
        let faceDetectionTimer = null;
        let captureTimer = null;
        const TOTAL_PHOTOS = 5;

        // Text-to-speech
        const speech = window.speechSynthesis;
        function speak(text) {
            if (speech) {
                speech.cancel(); // Cancel any ongoing speech
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                speech.speak(utterance);
            }
        }

        // Progress indicator
        function updateProgress(step) {
            const dots = document.querySelectorAll('.progress-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index < step) {
                    dot.classList.add('completed');
                } else if (index === step) {
                    dot.classList.add('active');
                }
            });
        }

        // Show/hide steps
        function showStep(stepId) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.getElementById(stepId).classList.add('active');
        }

        function nextStep(step) {
            currentStep = step;
            updateProgress(step);

            switch(step) {
                case 1:
                    showStep('step-name');
                    speak('Please enter your full name');
                    break;
                case 2:
                    showStep('step-camera');
                    break;
                case 3:
                    showStep('step-preview');
                    speak('Please review your photos');
                    break;
                case 4:
                    showStep('step-processing');
                    break;
                case 5:
                    showStep('step-success');
                    speak('Registration complete. Thank you!');
                    break;
            }
        }

        function prevStep(fromStep) {
            if (fromStep === 1) {
                currentStep = 0;
                updateProgress(0);
                showStep('step-welcome');
            }
        }

        // Show alert
        function showAlert(message, type = 'error') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // Validate link on page load
        async function validateLink() {
            try {
                const response = await fetch(`/api/registration-links/${linkId}/info`);
                const data = await response.json();

                if (!data.valid) {
                    showStep('step-welcome');
                    updateProgress(0);
                    showAlert(data.message, 'error');
                    document.querySelector('#step-welcome .btn').disabled = true;
                    speak('This registration link is invalid or expired');
                    return;
                }

                linkInfo = data;
                const locationInfo = document.getElementById('location-info');
                let infoText = `Registering for: ${data.location_name}`;
                if (data.link_name) {
                    infoText += ` - ${data.link_name}`;
                }
                locationInfo.textContent = infoText;

                showStep('step-welcome');
                updateProgress(0);
                speak('Welcome to BiometriX facial registration');
            } catch (error) {
                showStep('step-welcome');
                updateProgress(0);
                showAlert('Failed to validate registration link', 'error');
                document.querySelector('#step-welcome .btn').disabled = true;
            }
        }

        // Start camera
        async function startCamera() {
            const name = document.getElementById('person-name').value.trim();

            if (!name) {
                showAlert('Please enter your full name', 'error');
                speak('Please enter your full name');
                return;
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                const video = document.getElementById('video');
                video.srcObject = stream;

                nextStep(2);
                speak('Please position your face in the frame. We will automatically capture five photos.');

                // Wait for video to be ready
                video.onloadedmetadata = () => {
                    // Go fullscreen on mobile
                    if (window.innerWidth <= 600) {
                        document.getElementById('camera-container').classList.add('fullscreen');
                    }

                    // Start face detection after a brief delay
                    setTimeout(() => {
                        startFaceDetection();
                    }, 2000);
                };
            } catch (error) {
                showAlert('Camera access denied. Please allow camera access to continue.', 'error');
                speak('Camera access denied. Please allow camera access.');
            }
        }

        // Simple face detection (using video analysis)
        function startFaceDetection() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            let previousData = null;
            let motionDetected = false;
            let stableFrames = 0;

            updateStatus('Detecting face...');

            faceDetectionTimer = setInterval(() => {
                if (captureInProgress) return;

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                try {
                    const imageData = ctx.getImageData(
                        canvas.width * 0.3,
                        canvas.height * 0.2,
                        canvas.width * 0.4,
                        canvas.height * 0.5
                    );

                    // Calculate brightness in center area (where face should be)
                    let brightness = 0;
                    for (let i = 0; i < imageData.data.length; i += 4) {
                        brightness += (imageData.data[i] + imageData.data[i + 1] + imageData.data[i + 2]) / 3;
                    }
                    brightness /= (imageData.data.length / 4);

                    // Detect if there's sufficient brightness (indicating a face)
                    if (brightness > 50 && brightness < 200) {
                        if (!motionDetected) {
                            motionDetected = true;
                            document.getElementById('face-frame').classList.add('detected');
                            updateStatus('Face detected! Hold still...');
                        }

                        stableFrames++;

                        // If face is stable for 1 second, start capture
                        if (stableFrames >= 10) {
                            clearInterval(faceDetectionTimer);
                            startAutoCapture();
                        }
                    } else {
                        motionDetected = false;
                        stableFrames = 0;
                        document.getElementById('face-frame').classList.remove('detected');
                        updateStatus('Detecting face...');
                    }
                } catch (e) {
                    // Ignore errors from getImageData
                }
            }, 100);
        }

        // Auto capture sequence
        async function startAutoCapture() {
            captureInProgress = true;
            speak('Face detected. Starting capture.');
            updateStatus('Get ready...');

            // Countdown from 3
            for (let i = 3; i > 0; i--) {
                showCountdown(i);
                await sleep(1000);
            }

            // Capture profile photo first
            updateStatus('Capturing profile photo...');
            speak('Capturing profile photo');
            await captureProfilePhoto();
            await sleep(500);

            // Capture 5 photos
            for (let i = 0; i < TOTAL_PHOTOS; i++) {
                updateStatus(`Capturing photo ${i + 1} of ${TOTAL_PHOTOS}...`);
                speak(`Photo ${i + 1}`);
                await capturePhoto();
                updatePhotoProgress(i + 1);

                if (i < TOTAL_PHOTOS - 1) {
                    await sleep(800);
                }
            }

            // Capture complete
            updateStatus('Capture complete!');
            speak('All photos captured successfully');
            await sleep(1000);

            // Stop camera and show preview
            stopCamera();
            showPreview();
        }

        function showCountdown(number) {
            const overlay = document.getElementById('countdown-number');
            overlay.className = 'countdown-overlay';
            overlay.textContent = number;
            setTimeout(() => overlay.textContent = '', 900);
        }

        async function captureProfilePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Flash effect
            document.getElementById('capture-indicator').classList.add('flash');
            setTimeout(() => {
                document.getElementById('capture-indicator').classList.remove('flash');
            }, 300);

            profilePhoto = canvas.toDataURL('image/jpeg', 0.95);
        }

        async function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Flash effect
            document.getElementById('capture-indicator').classList.add('flash');
            setTimeout(() => {
                document.getElementById('capture-indicator').classList.remove('flash');
            }, 300);

            const photoData = canvas.toDataURL('image/jpeg', 0.95);
            capturedPhotos.push(photoData);
        }

        function updateStatus(message) {
            document.getElementById('status-message').textContent = message;
        }

        function updatePhotoProgress(count) {
            document.getElementById('photo-progress').textContent = `${count} / ${TOTAL_PHOTOS} photos`;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Show preview
        function showPreview() {
            const grid = document.getElementById('photo-preview-grid');
            grid.innerHTML = '';

            // Show profile photo first
            if (profilePhoto) {
                const item = document.createElement('div');
                item.className = 'photo-item profile';
                item.innerHTML = `<img src="${profilePhoto}" alt="Profile Photo">`;
                grid.appendChild(item);
            }

            // Show captured photos
            capturedPhotos.forEach((photo, index) => {
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `<img src="${photo}" alt="Photo ${index + 1}">`;
                grid.appendChild(item);
            });

            nextStep(3);
        }

        // Retake photos
        function retakePhotos() {
            speak('Restarting photo capture');
            capturedPhotos = [];
            profilePhoto = null;
            captureInProgress = false;
            startCamera();
        }

        // Cancel capture
        function cancelCapture() {
            stopCamera();
            capturedPhotos = [];
            profilePhoto = null;
            captureInProgress = false;
            prevStep(2);
        }

        // Stop camera
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (faceDetectionTimer) {
                clearInterval(faceDetectionTimer);
                faceDetectionTimer = null;
            }
            document.getElementById('camera-container').classList.remove('fullscreen');
        }

        // Submit registration
        async function submitRegistration() {
            if (capturedPhotos.length < TOTAL_PHOTOS) {
                showAlert('Not enough photos captured', 'error');
                return;
            }

            const name = document.getElementById('person-name').value.trim();

            nextStep(4);
            speak('Submitting your registration');

            try {
                const response = await fetch('/api/register-public', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        link_id: linkId,
                        person_name: name,
                        photos: capturedPhotos,
                        profile_photo: profilePhoto
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('success-message').textContent = data.message || 'You have been successfully registered!';
                    nextStep(5);
                } else {
                    showStep('step-preview');
                    updateProgress(3);
                    showAlert(data.detail || 'Registration failed. Please try again.', 'error');
                    speak('Registration failed. Please try again.');
                }
            } catch (error) {
                showStep('step-preview');
                updateProgress(3);
                showAlert('Network error. Please check your connection and try again.', 'error');
                speak('Network error. Please try again.');
            }
        }

        // Initialize
        validateLink();
    </script>
</body>
</html>
